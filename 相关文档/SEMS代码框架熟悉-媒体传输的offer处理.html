<html>
<head>
  <title>SEMS代码框架熟悉-媒体传输的offer处理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="994"/>
<h1>SEMS代码框架熟悉-媒体传输的offer处理</h1>

<div>
<span><div>AmBasicSipDialog.cpp</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(51, 51, 51);">void AmBasicSipDialog::onRxRequest(const AmSipRequest&amp; req)</span></div><div><span style="color: rgb(51, 51, 51);">{</span></div><div><span style="color: rgb(51, 51, 51);">    DBG(&quot;AmBasicSipDialog::onRxRequest(req = %s)\n&quot;, req.method.c_str());</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">    if(logger &amp;&amp; (req.method != SIP_METH_ACK)) {</span></div><div><span style="color: rgb(51, 51, 51);">        // log only non-initial received requests, the initial one is already logged</span></div><div><span style="color: rgb(51, 51, 51);">        // or will be logged at application level (problem with SBCSimpleRelay)</span></div><div><span style="color: rgb(51, 51, 51);">        if (!callid.empty()) req.log(logger);</span></div><div><span style="color: rgb(51, 51, 51);">    }</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">    <span style="color: rgb(45, 79, 201);"><b>if(!onRxReqSanity(req)) //调用派生类的OnRxReqSanity，除非派生类没有重新定义这个函数。如果是INVITE，它并不会OfferAnswer的任何修改</b></span></span></div><div><span style="color: rgb(51, 51, 51);">        return;</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">    uas_trans[req.cseq] = req;</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">    // target refresh requests</span></div><div><span style="color: rgb(51, 51, 51);">    if (req.from_uri.length() &amp;&amp;</span></div><div><span style="color: rgb(51, 51, 51);">        (remote_uri.empty() ||</span></div><div><span style="color: rgb(51, 51, 51);">         (req.method == SIP_METH_INVITE ||</span></div><div><span style="color: rgb(51, 51, 51);">      req.method == SIP_METH_UPDATE ||</span></div><div><span style="color: rgb(51, 51, 51);">      req.method == SIP_METH_SUBSCRIBE ||</span></div><div><span style="color: rgb(51, 51, 51);">      req.method == SIP_METH_NOTIFY))) {</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">      // refresh the target</span></div><div><span style="color: rgb(51, 51, 51);">      if (remote_uri != req.from_uri) {</span></div><div><span style="color: rgb(51, 51, 51);">          setRemoteUri(req.from_uri);</span></div><div><span style="color: rgb(51, 51, 51);">          if(nat_handling &amp;&amp; req.first_hop) {</span></div><div><span style="color: rgb(51, 51, 51);">              string nh = req.remote_ip + &quot;:&quot;</span></div><div><span style="color: rgb(51, 51, 51);">                + int2str(req.remote_port)</span></div><div><span style="color: rgb(51, 51, 51);">                + &quot;/&quot; + req.trsp;</span></div><div><span style="color: rgb(51, 51, 51);">              setNextHop(nh);</span></div><div><span style="color: rgb(51, 51, 51);">              setNextHop1stReq(false);</span></div><div><span style="color: rgb(51, 51, 51);">          }</span></div><div><span style="color: rgb(51, 51, 51);">      }</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">      string ua = getHeader(req.hdrs,&quot;User-Agent&quot;);</span></div><div><span style="color: rgb(51, 51, 51);">      setRemoteUA(ua);</span></div><div><span style="color: rgb(51, 51, 51);">    }</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">    // Dlg not yet initialized?</span></div><div><span style="color: rgb(51, 51, 51);">    if(callid.empty()){</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">        user         = req.user;</span></div><div><span style="color: rgb(51, 51, 51);">        domain       = req.domain;</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">        setCallid(      req.callid   );</span></div><div><span style="color: rgb(51, 51, 51);">        setRemoteTag(   req.from_tag );</span></div><div><span style="color: rgb(51, 51, 51);">        setLocalUri(    req.r_uri    );</span></div><div><span style="color: rgb(51, 51, 51);">        setRemoteParty( req.from     );</span></div><div><span style="color: rgb(51, 51, 51);">        setLocalParty(  req.to       );</span></div><div><span style="color: rgb(51, 51, 51);">        setRouteSet(    req.route    );</span></div><div><span style="color: rgb(51, 51, 51);">        set1stBranch(   req.via_branch );</span></div><div><span style="color: rgb(51, 51, 51);">        setOutboundInterface( req.local_if );</span></div><div><span style="color: rgb(51, 51, 51);">    }</span></div><div><span style="color: rgb(51, 51, 51);"><br/></span></div><div><span style="color: rgb(51, 51, 51);">    if(<span style="color: rgb(45, 79, 201);"><b>onRxReqStatus(req)</b></span> &amp;&amp; hdl)  <span style="color: rgb(45, 79, 201);"><b>//派生类需要重新实现该函数，在里面处理SDP的offer</b></span></span></div><div><span style="color: rgb(51, 51, 51);">       </span> hdl-&gt;onSipRequest(req);</div><div><span style="color: rgb(51, 51, 51);">}</span></div></div><div style="text-align: center"> |</div><div style="text-align: center"> |</div><div style="text-align: center"> V</div><div>AmSipDialog.cpp</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>bool AmSipDialog::onRxReqStatus(const AmSipRequest&amp; req)</div><div>{</div><div>    switch(status){</div><div>    case Disconnected:</div><div>        if(req.method == SIP_METH_INVITE)</div><div>            setStatus(Trying);</div><div>        break;</div><div>    case Connected:</div><div>        if(req.method == SIP_METH_BYE)</div><div>            setStatus(Disconnecting);</div><div>        break;</div><div><br/></div><div>    case Trying:</div><div>    case Proceeding:</div><div>    case Early:</div><div>        if(req.method == SIP_METH_BYE)</div><div>            setStatus(Disconnecting);</div><div>        else if(req.method == SIP_METH_CANCEL){</div><div>            setStatus(Cancelling);</div><div>            reply(req,200,&quot;OK&quot;);</div><div>        }</div><div>        break;</div><div><br/></div><div>    default: break;</div><div>    }</div><div><br/></div><div>    bool cont = true;</div><div>    if (offeranswer_enabled) {</div><div>        <span style="color: rgb(45, 79, 201);"><b>cont = (oa.onRequestIn(req) == 0); //oa为该类的成员变量，属于AmOfferAnswer类型 。</b></span></div><div>    }</div><div><br/></div><div>    return cont;</div><div>}</div><div><br/></div></div><div style="text-align: center"> |</div><div style="text-align: center"> |</div><div style="text-align: center"> V</div><div>AmOfferAnswer.cpp</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>int AmOfferAnswer::onRequestIn(const AmSipRequest&amp; req)</div><div>{</div><div>    saveState();</div><div><br/></div><div>    const char* err_txt  = NULL;</div><div>    int         err_code = 0;</div><div><br/></div><div>    if((req.method == SIP_METH_INVITE ||</div><div>        req.method == SIP_METH_UPDATE ||</div><div>        req.method == SIP_METH_ACK ||</div><div>        req.method == SIP_METH_PRACK) &amp;&amp;</div><div>       !req.body.empty() ) {</div><div><br/></div><div>        const AmMimeBody* sdp_body = req.body.hasContentType(SIP_APPLICATION_SDP);</div><div>        if(sdp_body)</div><div>            <span style="color: rgb(45, 79, 201);"><b>err_code = onRxSdp(req.cseq,*sdp_body,&amp;err_txt); //解析SDP，并更新offer的状态</b></span></div><div>    }</div><div><br/></div><div>    <span style="color: rgb(45, 79, 201);"><b>if(checkStateChange()){ //检查SDP的offer和Answer是否已完成</b></span></div><div>        err_code = 500;</div><div>        err_txt = &quot;internal error&quot;;</div><div>    }</div><div><br/></div><div>    if(err_code){</div><div>        if( req.method != SIP_METH_ACK ){ // INVITE || UPDATE || PRACK</div><div>            dlg-&gt;reply(req,err_code,err_txt);</div><div>        }</div><div>        else { // ACK</div><div>            // TODO: only if reply to initial INVITE (if re-INV, app should decide)</div><div>            DBG(&quot;error %i with SDP received in ACK request: sending BYE\n&quot;,err_code);</div><div>            dlg-&gt;bye();</div><div>        }</div><div>    }</div><div><br/></div><div>    if((req.method == SIP_METH_ACK) &amp;&amp;</div><div>       (req.cseq == cseq)){</div><div>        // 200 ACK received:</div><div>        //  -&gt; reset OA state</div><div>        DBG(&quot;200 ACK received: resetting OA state&quot;);</div><div>        clearTransitionalState();</div><div>    }</div><div><br/></div><div>    return err_code ? -1 : 0;</div><div>}</div><div><br/></div></div><div><br/></div><div><br/></div><div><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="font-size: 12px;"><br/></span></span></div></span>
</div></body></html> 