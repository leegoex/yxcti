<html>
<head>
  <title>20170320~20170325</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1102"/>
<h1>20170320~20170325</h1>

<div>
<span><div>20170320</div><div>1.使用SBC模块实现不同codec的转换。</div><div>手机端：    192.168.6.208 codec只支持G.711</div><div>电脑端：    192.168.6.155 codec只支持GSM，G.711</div><div>Kamailio： 192.168.6.185</div><div>SEMS：     192.168.6.113，其中SBC模块的配置为</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"># symmetricrtp SBC profile</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"># This implements a transparent B2BUA which relays RTP and forces</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"># symmetric RTP on both sides - thus being able to bridge between</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"># two NATed clients</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"># RURI/From/To defaults: transparent</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#RURI=$r</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#From=$f</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#To=$t</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">Call-ID=$ci</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">enable_rtprelay=yes</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">rtprelay_force_symmetric_rtp=yes</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">rtprelay_msgflags_symmetric_rtp=yes</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#rtprelay_transparent_seqno=no</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#rtprelay_transparent_ssrc=no</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#aleg_rtprelay_interface=intern</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#rtprelay_interface=default</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">#outbound_interface=extern</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">next_hop=192.168.6.185</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">enable_transcoder=always</span></span></span></div><div><span style="color: rgb(255, 0, 0);"><b><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;">codec_preference=gsm,ilbc,speex/8000,speex/16000,pcmu,pcma</span></span></b></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">transcoder_codecs=gsm,ilbc,speex/8000,speex/16000,pcmu,pcma</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">sdp_anonymize=yes</span></span></span></div></div><div>手机做主叫，RTP的流向为：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(28, 51, 135);"><b>                         G.711                         G.711</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>                       --------&gt;                     --------&gt;</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>192.168.6.208(g.711)                192.168.6.113                 192.168.6.155(gsm,g.711)</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>                       &lt;--------                     &lt;--------</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>                         G.711                          GSM</b></span></div></div><div>根据流向和抓包分析，我们推断SEMS是做了一次编码转换的。</div><div>电脑端做主叫，RTP的流向为：</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>  <b><span style="color: rgb(28, 51, 135);">                       G.711                         G.711</span></b></div><div><b><span style="color: rgb(28, 51, 135);">                       --------&gt;                     --------&gt;</span></b></div><div><b><span style="color: rgb(28, 51, 135);">192.168.6.208(g.711)                192.168.6.113                 192.168.6.155(gsm,g.711)</span></b></div><div><b><span style="color: rgb(28, 51, 135);">                       &lt;--------                     &lt;--------</span></b></div><div><b><span style="color: rgb(28, 51, 135);">                         G.711                         G.711</span></b></div></div><div>注意SBC模块配置文件中标注为红色的一行，如果将这一行注释掉，手机做主叫的场景RTP就不再会发生转码，全部为G.711。根据Readme.sbc.txt的解释，这个变量主要是用来调整SDP中codec的优先级的，<b>codec_preference</b>用来调整<b>主叫发往被叫</b>的SDP中codec的优先级。与此对应的还有另外一个变量<b>codec_preference_aleg</b>，它用来调整<b>被叫发往主叫</b>的SDP中codec的优先级。于是我们做如下实验，在SBC配置文件中同时添加codec_preference和codec_preference_aleg选项，并设置成一样的值，即配置成：</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>...</div><div><span style="color: rgb(255, 0, 0);"><b>codec_preference=gsm,ilbc,speex/8000,speex/16000,pcmu,pcma</b></span></div><div><span style="color: rgb(255, 0, 0);"><b>codec_preference_aleg=gsm,ilbc,speex/8000,speex/16000,pcmu,pcma</b></span><br/></div><div>...</div></div><div>测试结果发现，不管是手机做主叫，还是电脑做主叫，RTP流都变成了</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(28, 51, 135);"><b>                         G.711                         G.711</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>                       --------&gt;                     --------&gt;</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>192.168.6.208(g.711)                192.168.6.113                 192.168.6.155(gsm,g.711)</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>                       &lt;--------                     &lt;--------</b></span></div><div><span style="color: rgb(28, 51, 135);"><b>                         G.711                          GSM</b></span></div></div><div>下面，我们来做实验，让电脑端只支持GSM，SBC端同时配置<b>codec_preference</b>和<b>codec_preference_aleg。</b>经过测试，不管是手机端做主叫，还是电脑端做主叫，RTP流都编程了</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>                         G.711                          GSM</div><div>                       --------&gt;                     --------&gt;</div><div>192.168.6.208(g.711)                192.168.6.113                 192.168.6.155(gsm)</div><div>                       &lt;--------                     &lt;--------</div><div>                         G.711                          GSM</div></div><div>至此，在局域网上配置SEMS实现编码转换就完成了。最终SEMS的配置文件，SBC的配置文件和Kamailio的配置文件为：</div><div><a href="20170320~20170325_files/sems.conf"><img src="20170320~20170325_files/46cfb8163f529b0dcb5b850845bd2ccb.png" alt="sems.conf"></a><br/></div><div><a href="20170320~20170325_files/symmetricrtp.sbcprofile.conf"><img src="20170320~20170325_files/ed98b29d4a561d40365262fabad5538e.png" alt="symmetricrtp.sbcprofile.conf"></a></div><div><a href="20170320~20170325_files/kamailio.cfg"><img src="20170320~20170325_files/5fc0269b83dfdf8a2300d59281023bda.png" alt="kamailio.cfg"></a><br/></div><div><br/></div><div><br/></div><div>20170321</div><div>1.PC端使用Linphone做主叫时，Linphone的PC客户端收到“415 Unsupported Media Type”问题分析。</div><div>通过抓包分析做对比，出现这个问题的原因是Kamailio在转发INVITE信令时，同时转发给了SEMS和被叫。因为有一个信令没有经过SEMS中转，导致INVITE信令的SDP没有得到修改，从而出现媒体类型不支持的错误。伴随着这个错误的同时，SEMS也会出现“486 Busy Here”的错误。这是因为通过SEMS转发的INVITE信令比Kamailio直接转发的INVITE信令后到达被叫方，而被叫方同时只允许1路并发呼叫，所以导致了这个问题的出现。以下是各种情况下的Kamailio网络包情况：</div><div><a href="20170320~20170325_files/kamailio-app-linphone.pcap"><img src="20170320~20170325_files/7ba5eeafab2887b30ba83980ba6248ac.png" alt="kamailio-app-linphone.pcap"></a></div><div><a href="20170320~20170325_files/kamailio-pc-linphone.pcap"><img src="20170320~20170325_files/a75b261e1fb1686677313e6222b9dca9.png" alt="kamailio-pc-linphone.pcap"></a></div><div><a href="20170320~20170325_files/kamailio-pc-zoiper.pcap"><img src="20170320~20170325_files/51931b913cbdd4c948a371188ae5f530.png" alt="kamailio-pc-zoiper.pcap"></a><br/></div><div>通过对比发现，PC端的Linphone客户端在发起呼叫时，INVITE信令中的Contact头字段多了一个“sip.instance”的参数。这个参数可能是导致Kamailio同时转发给SEMS和被叫的原因。解决办法是换个PC客户端就可以了（例如Zoiper）</div><div><br/></div><div><br/></div><div>20170322</div><div>1.搭建测试服务器，测试SEMS对G.711到OPUS的转码性能</div><div><br/></div><div><br/></div><div>20170323</div><div>1.SEMS代码熟悉（插件加载和新session的创建）</div><div>2.SEMS 强制g.711到opus编码的配置</div><div><br/></div><div><br/></div><div>20170324</div><div>1.测试SEMS转码无声音的问题</div><div><br/></div><div><br/></div><div>20170325</div></span>
</div></body></html> 