<html>
<head>
  <title>kamailio.cfg的修改说明</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="850"/>
<h1>kamailio.cfg的修改说明</h1>

<div>
<span><div>1.</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(227, 0, 0);"><b>#!define WITH_DEBUG</b></span>        </div><div>#!define WITH_MYSQL</div><div>#!define WITH_AUTH</div><div>#!define WITH_USRLOCDB</div><div>#!define WITH_TLS</div><div>#!define WITH_HOMER</div><div>#!define WITH_WEBSOCKETS</div><div>#!define WITH_ANTIFLOOD</div></div><ul><li>#!define WITH_DEBUG主要用于启用更详细的输出log，方便问题的诊断。</li></ul><div><br/></div><div>2.</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(227, 0, 0);"><b>#!substdef &quot;!MY_IP_ADDR!192.168.6.202!g&quot;</b></span></div><div><span style="color: rgb(227, 0, 0);"><b>#!substdef &quot;!MY_DOMAIN!192.168.6.202!g&quot;</b></span></div><div><span style="color: rgb(227, 0, 0);"><b>#!substdef &quot;!MY_WS_PORT!20441!g&quot;</b></span></div><div><span style="color: rgb(227, 0, 0);"><b>#!substdef &quot;!MY_WSS_PORT!20443!g&quot;</b></span></div><div>#!substdef &quot;!MY_WS_ADDR!tcp:MY_IP_ADDR:MY_WS_PORT!g&quot;</div><div>#!substdef &quot;!MY_WSS_ADDR!tls:MY_IP_ADDR:MY_WSS_PORT!g&quot;</div></div><ul><li>将XX（此处省略了多个X）对应字段替换成本机IP地址。因为试验环境为局域网，没有配置域名环境，所以都用IP地址取代。如果使用的公网部署，可以用域名替换<b><span style="color: rgb(227, 0, 0);">MY_DOMAIN</span></b>对应的IP地址。</li><li>修改端口，尽量使用非标准端口。</li></ul><div><br/></div><div><br/></div><div>3.</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div>fork=yes</div><div>children=4</div><div><br/></div><div><span style="color: rgb(227, 0, 0);"><b>alias=&quot;rtc.gzyzmb.com&quot;</b></span></div><div><br/></div><div>/* port to listen to</div><div> * - can be specified more than once if needed to listen on many ports */</div><div>port=5060</div></div><ul><li>alias=&quot;rtc.gzyzmb.com&quot;添加服务器别名。这里主要是用于解决服务器TLS证书的问题。因为局域网环境无法使用letsencrypt来生成公钥和私钥证书，所以我们使用了用域名rtc.gzyzmb.com这个公网域名生成的证书。只有使用了证书之后，浏览器才能使用wss协议来访问我们的SIP服务。需要注意的是：因为我们使用的rtc.gzyzmb.com这个公网域名的证书，所以浏览器使用wss协议时必须将请求发往wss://rtc.gzyzmb.com:20443，但是我们的SIP服务器是部署在一台局域网机器的，所以在路由器上我们必须做一个端口映射，将来自端口20443的数据包转发到部署SIP服务的机器上。当部署SIP服务的机器收到该数据包之后，发现数据包中中的请求地址(Request-URI)是rtc.gzyzmb.com，并不是自己的地址（不在kamailio内置变量myself中）就会丢弃这个数据包。通过添加<b><span style="color: rgb(227, 0, 0);">alias=&quot;rtc.gzyzmb.com&quot;</span></b>之后就能将rtc.gzyzmb.com添加到myself中，从而解决这个问题。</li></ul><div><br/></div><div><br/></div><div>4.</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div>#!ifdef WITH_SRCPATH</div><div>mpath=&quot;modules/&quot;</div><div>#!else</div><div><span style="color: rgb(227, 0, 0);"><b>mpath=&quot;/home/CloudShare/lib/kamailio/modules/&quot;</b></span></div><div>#!endif</div></div><ul><li>修改成kamailio的安装地址</li></ul><div><br/></div><div><br/></div><div>5.</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div>#!ifdef WITH_TLS</div><div># ----- tls params -----</div><div><span style="color: rgb(227, 0, 0);"><b>modparam(&quot;tls&quot;, &quot;config&quot;, &quot;/home/CloudShare/etc/kamailio/tls.cfg&quot;)</b></span></div><div>#!endif</div></div><ul><li>替换成tls.cfg所在路径</li></ul><div><br/></div><div><br/></div><div>6.</div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div>route[NATMANAGE] {</div><div>        if (is_request()) {</div><div>                if(has_totag()) {</div><div>                        if(check_route_param(&quot;nat=yes&quot;)) {</div><div>                                setbflag(FLB_NATB);</div><div>                        }</div><div>                }</div><div>        }</div><div>        if (!(isflagset(FLT_NATS) || isbflagset(FLB_NATB)))</div><div>                return;</div><div><br/></div><div><span style="color: rgb(227, 0, 0);"><b>        rtpengine_manage(&quot;trust-address replace-origin replace-session-connection ICE=force RTP/SAVP&quot;);</b></span></div><div><br/></div><div>        if (is_request()) {</div><div>                if (!has_totag()) {</div><div>                        if(t_is_branch_route()) {</div><div>                                add_rr_param(&quot;;nat=yes&quot;);</div><div>                        }</div><div>                }</div><div>        }</div><div>        if (is_reply()) {</div><div>                if(isbflagset(FLB_NATB)) {</div><div>                        if(is_first_hop())</div><div>                                set_contact_alias();</div><div>                }</div><div>        }</div><div>        return;</div><div>}</div></div><div>添加RTP转发，用来处理SIP软电话和SIP软电话通话时，如果至少有一方在NAT下，会出现语音单通或双不通的问题。</div><div><b>NOTE:通话的双方必须支持ICE和语音加密功能（SRTP），否则无法建立通话。（如果有任何一方不支持ICE或SRTP，该如何修改这个配置？？？）</b></div><ul><li>trust-address:将SDP中的IP地址设置为信任IP。从rtpengine 3.8版本开始，这个选项为默认项。在早期的版本中，如果没有设置这个选项，RTP代理会忽略SDP中的IP地址，转而使用SIP信令中的源地址来转发媒体流</li><li>replace-origin:SDP中的o=(origin description)对应的IP必须修改成RTP代理地址</li><li>replace-session-connection:如果SDP中包含c=(session-level SDP connection)，则对应的IP也必须修改成RTP代理的地址</li><li>ICE=force:根据SDP中的ICE属性控制RTP代理的行为。可选值有：
<ul><li><b>force</b>: <span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;">discard any ICE attributes already present in the </span><acronym style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">SDP</acronym><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;"> body and then generate and insert new ICE data, leaving itself as the </span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><em>only</em></span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;"> ICE candidates</span></li><li><b>force-relay</b>: <span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;">discard any </span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">“relay”</span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;"> type ICE attributes already present in the </span><acronym style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">SDP</acronym><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;"> body and then generate and insert itself as the </span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><em>only</em></span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;"> ICE </span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">“relay”</span><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;"> candidates</span></li><li><b>remove</b>: <span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;">instructs the </span><acronym style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">RTP</acronym><span style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); float: none; display: inline !important;"> proxy to discard any ICE attributes and not insert any new ones into the </span><acronym style="color: rgb(0, 0, 0); font-size: 12px; font-style: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">SDP</acronym></li></ul></li><li>RTP/SAVP:表示同时设置SRTP和AVPF两个标识，是一种便捷的的方式。</li></ul><div><br/></div><div>7.</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="color: rgb(51, 51, 51);">To Be Continued...</span></span></div></div><div><br/></div></span>
</div></body></html> 