<html>
<head>
  <title>README.rtpengine</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="856"/>
<h1>README.rtpengine</h1>

<div>
<span><div><b><span style="font-size: 16px;">1.Overview</span></b></div><div>这个模块使通话双方的媒体流通过一个RTP代理服务器来中转。这个RTP代理服务器只能是rtpengine。rtpengine</div><div><br/></div><div><span style="font-size: 16px;"><b>2.Multiple RTP proxy usage</b></span></div><div>rtpengine模块支持多个RTP代理服务器，以便支持负载均衡和分布式部署的需要。</div><div><br/></div><div><span style="font-size: 16px;"><b>3.Dependencies</b></span></div><div><br/></div><div><span style="font-size: 16px;"><b>4.Parameters</b></span></div><div><b>4.1 rtpengine_sock(string)</b></div><div>定义RTP代理服务器的连接地址。默认值为“NONE”，表示不启用RTP代理。地址格式支持UNIX socket或IPv4/IPv6 UDP socket。</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>...</div><div># single rtpproxy</div><div>modparam(&quot;rtpengine&quot;, &quot;rtpengine_sock&quot;, &quot;udp:localhost:12221&quot;)</div><div># multiple rtpproxies for load balance with weights (missing weight defaults to 1)</div><div>modparam(&quot;rtpengine&quot;, &quot;rtpengine_sock&quot;, &quot;udp:localhost:12221=2 udp:localhost:12222=1&quot;)</div><div># multiple sets of multiple rtpproxies</div><div>modparam(&quot;rtpengine&quot;, &quot;rtpengine_sock&quot;, &quot;1 == udp:localhost:12221 udp:localhost:12222&quot;)</div><div>modparam(&quot;rtpengine&quot;, &quot;rtpengine_sock&quot;, &quot;2 == udp:localhost:12225&quot;)</div><div>...</div></div><div><br/></div><div>4.2 <b>rtpengine_disable_tout(integer)</b></div><div>一旦某个RTP代理服务器被发现无法连接被标记为disabled后，rtpengine还会尝试与其建立连接，直至到达该参数指定的超时时间，就不再尝试。默认值为60秒。</div><div><br/></div><div><b>4.3 rtpengine_tout_ms(integer)</b></div><div>向RTP代理服务器发送消息后等待回复的超时时间，以毫秒为单位，默认值为1000。</div><div><br/></div><div><b>4.4 rtpengine_allow_op(integer)</b></div><div>(没看懂)</div><div><br/></div><div>4.5 queried_nodes_limit(integer)</div><div><br/></div><div><b>4.6 rtpengine_retr(integer)</b></div><div>设置发送或接收超时后的尝试次数。</div><div><br/></div><div>4.7 extra_id_pv(string)</div><div><br/></div><div><b>4.8 setid_avp(string)</b></div><div>设置一个AVP，使rtpengine_offer，rtpengine_answer，rtpengine_delete和rtpengine_manage能确定使用哪个组中的RTP代理服务器。</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>...</div><div>modparam(&quot;rtpengine&quot;, &quot;setid_avp&quot;, &quot;$avp(setid)&quot;)</div><div>...</div></div><div><br/></div><div>4.9</div><div>4.10</div><div>4.11</div><div>4.12</div><div>4.13</div><div>4.14</div><div>4.15</div><div>4.16</div><div>4.17</div><div>4.18</div><div>4.19</div><div>4.20</div><div>4.21</div><div><br/></div><div><br/></div><div><b><span style="font-size: 16px;">5.Functions</span></b></div><div><b>5.1. set_rtpengine_set(setid[, setid])</b></div><div>设置一个组id，当调用rtpengine_offer，rtpengine_answer，rtpengine_delete或者rtpengine_manage时，就使用指定组中的RTP代理服务器。该函数可以指定两个组id，其中第二个组id是可选的。当第二个组id也设置的时候，它指的是：主要用第一个参数指定的组中的RTP代理服务器，而被叫用第二个参数指定的组中的RTP代理服务器（那么两个RTP代理服务器之间怎么针对这个通话做关联？）。需要注意的是：两个id不能相同，并且两组RTP代理服务器不能有交集。第二个参数对于rtpengine_manage函数无效。</div><div><br/></div><div><b>5.2. rtpengine_offer([flags])</b></div><div>重新SDP内容，以保证媒体流是通过RTP带来来中转。</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>route {</div><div>...</div><div>    if(is_method(&quot;INVITE&quot;)) {</div><div>        if(has_body(&quot;application/sdp&quot;)) {</div><div>            if(rtpengine_offer()) {</div><div>                t_on_reply(&quot;1&quot;);</div><div>            }</div><div>        } else {</div><div>            t_on_reply(&quot;2&quot;);</div><div>        }</div><div>    }</div><div>    if(is_method(&quot;ACK&quot;) &amp;&amp; has_body(&quot;application/sdp&quot;))</div><div>        rtpengine_answer();</div><div>...</div><div>}</div><div>onreply_route[1] {</div><div>...</div><div>    if(has_body(&quot;application/sdp&quot;))</div><div>        rtpengine_answer();</div><div>...</div><div>}</div><div>onreply_route[2] {</div><div>...</div><div>    if(has_body(&quot;application/sdp&quot;))</div><div>        rtpengine_offer();</div><div>...</div><div>}</div></div><div><br/></div><div><b>5.3. rtpengine_answer([flags])</b></div><div>重新SDP内容，以保证媒体流是通过RTP带来来中转。</div><div><br/></div><div><b>5.4. rtpengine_delete([flags])</b></div><div>删除当前通话的RTP会话。</div><div><br/></div><div><b>5.5. rtpengine_manage([flags])</b></div><div>管理RTP代理中的会话。该函数组合了rtpengine_offer，rtpengine_answer和rtpengine_delete三个函数的功能。它会根据SIP信令的方法和消息类型来决定调用哪个函数。具体规则如下：</div><ul><li>如果是收到INVITE，并且该INVITE带SDP，则执行rtpengine_offer的功能；</li><li>看不懂</li><li>如果是带SDP的ACK信令，则执行rtpengine_answer功能；</li><li>如果是BYE或者CANCEL信令，抑或是在FAILURE_ROUTE中调用，则执行rtpengine_delete功能；</li><li>如果是针对INVITE的回复，其状态码&gt;=300，则执行rtpengine_delete功能；</li><li>如果是针对INVITE的回复，其状态码为1xx或2xx，并且该回复带SDP，则执行rtpengine_answer功能。否则执行rtpengine_offer功能。</li></ul><div><br/></div><div><b>5.6. start_recording()</b></div><div>现在不支持？？？</div><div><br/></div><div><span style="font-size: 16px;"><b>6.Exported Pseudo Variables</b></span></div><div><b>6.1 $rptstat</b></div><div>返回RTP代理的RTP统计信息（应该是针对某个具体通话的）。必须在调用rtpengine_delete函数之前获取。</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>...</div><div>    append_hf(&quot;X-RTP-Statistics: $rtpstat\r\n&quot;);</div><div>...</div></div><div><br/></div><div><span style="font-size: 16px;"><b>7.MI Commands</b></span></div><div><b>7.1 nh_enable_rtpp proxy_url/all 0/1</b></div><div>启用或禁用某个或所有的RTP代理服务器。当尝试去启用某个RTP代理服务器时，首先会向这个服务器发送一个PING命令，如果PING失败了，这个服务器将不会被启用。以下是几点需要注意的事项：</div><ul><li>如果某个RTP代理服务器被定义了多次（不管是定义在同一个组中，还是在不同的组中），通过该命令来启用或禁用这个RTP代理服务器将会使它的所有实例生效；</li><li>如果尝试去启用一个处于“(permanent)”状态的代理服务器，即使PING失败了，也会将该服务器置于disable temporary状态，并给它赋予一个recheck_ticks值。如果这个recheck_ticks值大于0，那么它的状态就是disable temporary状态，并不会向它发送数据；如果recheck_ticks值等于0，则需要向它发送数据来做新的测试，如果发送数据成功，则表示启用成功。</li><li>当RTP代理地址为IPv6格式时，需要用::开头。</li></ul><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>...</div><div>kamctl fifo nh_enable_rtpp udp:192.168.2.133:8081 0</div><div>kamctl fifo nh_enable_rtpp ::udp6:fe80:9a90:96ff:fea8:fd99:9999 1</div><div>kamctl fifo nh_enable_rtpp all 1</div><div>...</div></div><div><br/></div><div><b>7.2 nh_show_rtpp proxy_url/all</b></div><div>显示指定或所有RTP代理服务器的信息，这些信息包括：所属的组id，是否被禁用，最大负载（weight）和recheck_ticks。如果某个代理服务器通过nh_enable_rtpp命令被禁用了，那么在是否被禁用栏将会显示成“(permanent)”。如果显示了“(permanent)”，那么recheck_ticks也没有意义了，它将会显示成“N/A”。</div><div><br/></div><div><b>7.3 nh_ping_rtpp proxy_url/all</b></div><div>向指定或所有的RTP代理服务器发送PING消息。如果PING失败，则将服务器职位disable temporary。</div><div><br/></div><div><b>7.4 nh_reload_rtpp</b></div><div>重新加载数据库表中关于RTP代理服务器的配置。</div><div><br/></div><div><b>7.5 nh_show_hash_total</b></div><div>显示当前时刻哈希表中entries的总数。</div><div><br/></div><div><a href="README.rtpengine_files/README.rtpengine"><img src="README.rtpengine_files/79d739c33f83263c155306df2f756e31.png" alt="README.rtpengine"></a></div><div><br/></div></span>
</div></body></html> 