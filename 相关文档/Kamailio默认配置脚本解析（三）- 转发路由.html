<html>
<head>
  <title>Kamailio默认配置脚本解析（三）- 转发路由</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="820"/>
<h1>Kamailio默认配置脚本解析（三）- 转发路由</h1>

<div>
<span><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>01 route[RELAY] {</div><div>02     if(is_method(&quot;INVITE|BYE|SUBSCRIBE|UPDATE&quot;)) {</div><div>03         if(!t_is_set(&quot;branch_route&quot;))</div><div>04             t_on_branch(&quot;MANAGE_BRANCH&quot;);</div><div>05     }</div><div>06     if(is_method(&quot;INVITE|SUBSCRIBE|UPDATE&quot;)) {</div><div>07         if(!t_is_set(&quot;onreply_route&quot;))</div><div>08             t_on_reply(&quot;MANAGE_REPLY&quot;);</div><div>09     }</div><div>10     if(is_method(&quot;INVITE&quot;)) {</div><div>11         if(!t_is_set(&quot;failure_route&quot;))</div><div>12             t_on_failure(&quot;MANAGE_FAILURE&quot;);</div><div>13     }</div><div>14     if(!t_relay()) {</div><div>15         sl_reply_error();</div><div>16     }</div><div>17     exit;</div><div>}</div></div><div><br/></div><div>03.t_is_set函数由模块tm.so提供，该函数的主要功能是：</div><div>如果脚本文件中有定义branch_route路由，则该函数返回true；否则返回false。</div><div>以下内容摘自README.tm：</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>5.49.  t_is_set(target)</div><div><br/></div><div>   Return true if the attribute specified by 'target' is set for</div><div>   transaction.</div><div><br/></div><div>   The target parameter can be:</div><div>     * branch_route - the function returns true if a branch route is set</div><div>       to be executed.</div><div>     * failure_route - the function returns true if a failure route is set</div><div>       to be executed.</div><div>     * onreply_route - the function returns true if an onreply route is</div><div>       set to be executed.</div><div><br/></div><div>   Example 1.88. t_replicate usage</div><div>...</div><div>if(!t_is_set(&quot;failure_route&quot;))</div><div>    LM_DBG(&quot;no failure route will be executed for current transaction\n&quot;);</div><div>...</div></div><div><br/></div><div>04.t_on_branch函数由模块tm.so提供，该函数的主要功能是：</div><div>开启一个新的进程，并用这个进程来执行branch_route参数指定的分支路由规则。</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>5.9.  t_on_branch(branch_route)</div><div><br/></div><div>   Sets the branch routing block, to which control is passed after forking</div><div>   (when a new branch is created). For now branch routes are intended only</div><div>   for last minute changes of the SIP messages (like adding new headers).</div><div>   Note that the set of commands which are usable within branch_routes is</div><div>   very limited. It is not possible to generate a reply.</div><div><br/></div><div>   Meaning of the parameters is as follows:</div><div>     * branch_route - branch route block to be called.</div><div><br/></div><div>   Example 1.52. t_on_branch usage</div><div>...</div><div>route {</div><div>        t_on_branch(&quot;1&quot;);</div><div>        t_relay();</div><div>}</div><div><br/></div><div>branch_route[1] {</div><div>        if (uri=~&quot;sip:[0-9]+&quot;){</div><div>                append_hf(&quot;P-Warn: numeric uri\r\n&quot;);</div><div>        }</div><div>}</div></div><div><br/></div><div>08.t_on_reply函数由模块tm.so提供，该函数的功能是：</div><div>将控制权传递给一个回复路由，当收到该transaction的某个回复的时候。需要注意的是，onreply_route路由中能使用的命令是有限的。</div><div><br/></div><div>12.t_on_failure函数由模块tm.so提供，该函数的功能是：</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>5.6.  t_on_failure(failure_route)</div><div><br/></div><div>   Sets failure routing block, to which control is passed after a</div><div>   transaction completed with a negative result but before sending a final</div><div>   reply. In the referred block, you can either start a new branch (good</div><div>   for services such as forward_on_no_reply) or send a final reply on your</div><div>   own (good for example for message silo, which received a negative reply</div><div>   from upstream and wants to tell upstream &quot;202 I will take care of it&quot;).</div><div>   Note that the set of commands which are usable within failure_routes is</div><div>   strictly limited to rewriting URI, initiating new branches, logging,</div><div>   and sending stateful replies (t_reply). Any other commands may result</div><div>   in unpredictable behavior and possible server failure. Note that</div><div>   whenever failure_route is entered, uri is reset to value which it had</div><div>   on relaying. If it temporarily changed during a reply_route processing,</div><div>   subsequent reply_route will ignore the changed value and use again the</div><div>   original one.</div><div><br/></div><div>   Meaning of the parameters is as follows:</div><div>     * failure_route - Failure route block to be called.</div><div><br/></div><div>   Example 1.49. t_on_failure usage</div><div>...</div><div>route {</div><div>    t_on_failure(&quot;1&quot;);</div><div>    t_relay();</div><div>}</div><div><br/></div><div>failure_route[1] {</div><div>    revert_uri();</div><div>    setuser(&quot;voicemail&quot;);</div><div>    append_branch();</div><div>}</div><div>...</div><div><br/></div><div>   See test/onr.cfg for a more complex example of combination of serial</div><div>   with parallel forking.</div></div><div><br/></div><div>14.t_relay函数由模块tm.so提供，该函数的功能是：</div><div>有状态地转发某个消息到目标地址或者指定目标地址转发。</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 