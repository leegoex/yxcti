<html>
<head>
  <title>README.usrloc</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="922"/>
<h1>README.usrloc</h1>

<div>
<span><div><span style="font-size: 16px;"><b>1.Overview</b></span></div><div>该模块用来管理一张用户的位置信息表，并提供给其他模块使用。这个模块没有提供相关的函数，其他模块可以直接使用表中的数据。</div><div>如何匹配数据库表中的记录是该模块的一个最重要的内容，尤其是涉及到NAT传输的时候。例如：处于同一个NAT下的多个客户端，使用相同的账号注册；或者某个账号重新注册，由于NAT的关系，使用了不同的IP或端口等。</div><div>SIP RFC3261提出了一种匹配算法，该算法是主要根据Contact中的值做匹配，如果Contact一致，则额外检查Call-ID和CSeq（如果Call-ID一样，则CSeq必须比当前记录的CSeq值大，否则就是无效的注册）。但是，注册请求来自NAT底下是，这种算法就无法适应，所以Kamalio提供了更多的匹配算法：</div><ul><li>Contact based only - 完全按照RFC3261进行匹配</li><li>Contact and Call-ID based - RFC3261的扩展，</li><li>Contact and Path based - RFC3261的扩展</li><li>Call-ID only based - 不依赖RFC3261，完全根据Call-ID进行匹配</li></ul><div><br/></div><div><span style="font-size: 16px;"><b>2.Dependencies</b></span></div><div><br/></div><div><span style="font-size: 16px;"><b>3.Parameters</b></span></div><div><b>3.1 nat_bflag(integer)</b></div><div>设置一个branch flag值，当被处理的信令被标记为NAT时，可以通过检查这个值来做相应的处理。</div><div><br/></div><div>3.2 user_column(string)</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">+---------------+------------------+------+-----+---------------------+----------------+</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| Field         | Type             | Null | Key | Default             | Extra          |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">+---------------+------------------+------+-----+---------------------+----------------+</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| id            | int(10) unsigned | NO   | PRI | NULL                | auto_increment |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| ruid          | varchar(64)      | NO   | UNI |                     |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| username      | varchar(64)      | NO   | MUL |                     |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| domain        | varchar(64)      | YES  |     | NULL                |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| contact       | varchar(255)     | NO   |     |                     |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| received      | varchar(128)     | YES  |     | NULL                |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| path          | varchar(512)     | YES  |     | NULL                |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| expires       | datetime         | NO   | MUL | 2030-05-28 21:32:15 |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| q             | float(10,2)      | NO   |     | 1.00                |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| callid        | varchar(255)     | NO   |     | Default-Call-ID     |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| cseq          | int(11)          | NO   |     | 1                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| last_modified | datetime         | NO   |     | 1900-01-01 00:00:01 |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| flags         | int(11)          | NO   |     | 0                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| cflags        | int(11)          | NO   |     | 0                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| user_agent    | varchar(255)     | NO   |     |                     |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| socket        | varchar(64)      | YES  |     | NULL                |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| methods       | int(11)          | YES  |     | NULL                |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| instance      | varchar(255)     | YES  |     | NULL                |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| reg_id        | int(11)          | NO   |     | 0                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| server_id     | int(11)          | NO   | MUL | 0                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| connection_id | int(11)          | NO   |     | 0                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| keepalive     | int(11)          | NO   |     | 0                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">| partition     | int(11)          | NO   |     | 0                   |                |</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">+---------------+------------------+------+-----+---------------------+----------------+</span></span></span></div></div><div>3.3 domain_column(string)</div><div>3.4 contact_column(string)</div><div>3.5 expires_column(string)</div><div>3.6 q_column(string)</div><div>3.7 callid_column(string)</div><div>3.8 cseq_column(string)</div><div>3.9 methods_column(string)</div><div>3.10 flags_column(string)</div><div>3.11 cflags_column(string)</div><div>3.12 user_agent_column(string)</div><div>3.13 received_column(string)</div><div>3.14 socket_column(string)</div><div>3.15 path_column(string)</div><div>3.16 ruid_column(string)</div><div>3.17 instance_column(string)</div><div>3.18 server_id_column(string)</div><div>3.19 connection_id_column(string)</div><div>3.20 keepalive_column(string)</div><div><br/></div><div><b>3.21 use_domain(integer)</b></div><div>通过设置这个变量来通知Kamailio是否保存用户的域名来确定一个用户。对于多域名场景时非常有用。非0值表示启用；否则不启用。</div><div><br/></div><div><b>3.22 desc_time_order(integer)</b></div><div>通过设置这个变量来告知Kamailio按时间戳来排序数据库表中的记录。默认为用q值排序。</div><div><br/></div><div><b>3.23 timer_interval(integer)</b></div><div>定时器时间间隔，以秒为单位。</div><div><br/></div><div><b>3.24 db_url(string)</b></div><div><br/></div><div><b>3.25 db_mode(integer)</b></div><div>该模块实现了5中数据保存模式，分别是：</div><ul><li>0 - 不使用数据库保存用户注册信息，用户注册信息只保存在内存中</li><li>1 - 用户注册信息同时保存到内存和数据库中，并且一旦注册信息发生变化，马上将相应的变化更新到数据库中。这非常慢，但非常可靠，并且因为做了信息持久化处理，数据基本不会丢失</li><li>2 - 与1模式类似，区别在于：内存中的注册信息发生变化，并不会马上更新到数据库中，而是通过一个定时器来执行同步的操作。</li><li>3 - 用户的注册信息只保存的数据库中</li><li>4 - 该模式指的是：启动时使用数据库中的数据，运行过程中只使用内存保存数据。内存中的数据并不会更新到数据库中。</li></ul><div><br/></div><div><b>3.26 maching_mode(integer)</b></div><div>用户信息匹配算法：</div><div>0 - CONTACT only</div><div>1 - CONTACT and CALLID</div><div>2 - CONTACT and PATH。该算法与0类似，但是允许同一用户从不同的路径来注册，如果没有Path:头，那么其功能与0一样。</div><div>3 - CALLID only</div><div><br/></div><div>3.27 cseq_delay(integer)</div><div>重发请求的超时设置，以秒为单位，默认值为20秒。重发的请求根据Call-ID和Cseq来匹配。超时的开始时间以第1次收到REGISTER请求开始计算。</div><div><br/></div><div>3.28 fetch_rows(integer)</div><div>每次从数据库获取记录的最大记录数。默认值为2000条。</div><div><br/></div><div>3.29 hash_size(integer)</div><div>3.30 preload(string)</div><div>3.31</div><div>3.32</div><div>3.33</div><div>3.34</div><div>3.35</div><div>3.36</div><div>3.37</div><div>3.38</div><div>3.39</div><div>3.40</div><div>3.41</div><div>3.42</div><div><br/></div><div>4.Functions</div><div><br/></div><div>5.MI Commands</div><div><br/></div><div>6.RPC Commands</div><div><br/></div><div>7.Statistics</div></span>
</div></body></html> 