<html>
<head>
  <title>Kamailio默认配置脚本解析（一）-SIP请求信令的初始化检查</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="814"/>
<h1>Kamailio默认配置脚本解析（一）-SIP请求信令的初始化检查</h1>

<div>
<span><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>01 route[REQINIT] {</div><div>02    if(!mf_process_maxfwd_header(&quot;10&quot;)) {</div><div>03         sl_send_reply(&quot;483&quot;, &quot;Too Many Hops&quot;);</div><div>04         exit;</div><div>05     }</div><div><br/></div><div>06     if(is_method(&quot;OPTIONS&quot;) &amp;&amp; uri==myself &amp;&amp; $rU==$null) {</div><div>07         sl_send_reply(&quot;200&quot;, &quot;Keepalive&quot;);</div><div>08         exit;</div><div>09     }</div><div><br/></div><div>10     if(!sanity_check(&quot;1511&quot;, &quot;7&quot;)) {</div><div>11         xlog(&quot;Malformed SIP message from $si:$sp\n&quot;);</div><div>12         exit;</div><div>13     }</div><div>14 }</div></div><div><br/></div><div>01. 以关键字route命名的路由为子路由。子路由可以被任何其他路由调用。子路由可以返回一个整数值给它的调用者，这个返回值可以通过变量$rc来获取。子路由返回的整数值不同，代表了不同的意义：</div><ul><li>负值表示false</li><li>0表示退出(exit)</li><li>正值表示true</li></ul><div><br/></div><div>02.mf_process_maxfwd_header函数由模块maxfwd.so提供。该函数提供的功能是：</div><div>如果收到的SIP请求信令中没有Max-Forwards头，那么该函数会给这个信令添加一个Max-Forwards头，并将其值赋值为括号中参数指定的值；如果收到的SIP请求信令中后Max-Forwards头，那么该函数会将该头对应的值递减（大于0才会执行递减操作）。该函数的返回值具有如下意义：</div><ul><li>返回值为2 - SIP请求信令中没有Max-Forwards头，并且成功添加了一个Max-Forwards的头，并赋值为参数传递进来的值</li><li>返回值为1 - SIP请求信令中有Max-Forwards头，该值大于0，并且成功执行了一次递减操作</li><li>返回值为-1 - SIP请求信令中有Max-Forwards头，且该值为0</li><li>返回值为-2 - 该函数执行时发生错误</li></ul><div>该函数的返回值可以通过变量$retcode（或者$?）来获取</div><div><br/></div><div>03.sl_send_reply函数由模块sl.so（Statless request handling ）提供，该函数提供的功能是：</div><div>给当前收到的SIP请求信令做出回复，使用参数指定的返回码和原因。该回复是无状态的，并且对于INVITE请求，该回复不会重发。</div><div><br/></div><div>04.exit关键字用来结束当前整个脚本的执行</div><div><br/></div><div>06.is_method函数由模块textops.so提供，该函数提供的功能是：</div><div>检查SIP信令是否与参数指定的名称一致。该函数的参数以如下方式提供：'method1|method2|...'。当使用|将多种method联合起来时，这些method必须保证是Kamailio定义的method ID(这些ID用整数来定义)，否则，就只能用字符串作为参数传递，当用字符串作为参数传递时，就不能使用|操作符了。需要注意的是，当该函数在reply路由中使用时，它检查的字段就变成了CSeq头。</div><div>uri内置变量对应SIP请求信令中的Request-URI头（也可用用变量$ru来获取）。myself是一个集合，它包含了SIP服务器的所有IP，主机名和可以访问的域名。</div><div>$rU - Username in Request-URI</div><div><br/></div><div>10.sanity_check函数由模块sanity.so（SIP syntax checking）提供，该函数提供的功能是：</div><div>检查SIP请求信令是否是一个标准的SIP信令。</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">1151 = 1024+256+128+64+32+4+2+1</span></span></div><div><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">7    = 4+2+1</span></span></div></div><div>以下剪贴自README.sanity:</div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(51, 51, 51);"> The following checks are available:</span></div><div><span style="color: rgb(51, 51, 51);"> * ruri sip version - (1) - checks if the SIP version in the request</span></div><div><span style="color: rgb(51, 51, 51);">   URI is supported, currently only 2.0.</span></div><div><span style="color: rgb(51, 51, 51);"> * ruri scheme - (2) - checks if the URI scheme of the request URI is</span></div><div><span style="color: rgb(51, 51, 51);">   supported (sip[s]|tel[s]) by Kamailio</span></div><div><span style="color: rgb(51, 51, 51);"> * required headers - (4) -checks if the minimum set of required</span></div><div><span style="color: rgb(51, 51, 51);">   headers to, from, cseq, callid and via is present in the request.</span></div><div><span style="color: rgb(51, 51, 51);"> * via sip version - (8) - not working because parser fails already</span></div><div><span style="color: rgb(51, 51, 51);">   when another version then 2.0 is present.</span></div><div><span style="color: rgb(51, 51, 51);"> * via protocol - (16) - not working because parser fails already if</span></div><div><span style="color: rgb(51, 51, 51);">   an unsupported transport is present.</span></div><div><span style="color: rgb(51, 51, 51);"> * Cseq method - (32) - checks if the method from the Cseq header is</span></div><div><span style="color: rgb(51, 51, 51);">   equal to the request method.</span></div><div><span style="color: rgb(51, 51, 51);"> * Cseq value - (64) - checks if the number in the Cseq header is a</span></div><div><span style="color: rgb(51, 51, 51);">   valid unsigned integer.</span></div><div><span style="color: rgb(51, 51, 51);"> * content length - (128) - checks if the size of the body matches</span></div><div><span style="color: rgb(51, 51, 51);">   with the value from the content length header.</span></div><div><span style="color: rgb(51, 51, 51);"> * expires value - (256) - checks if the value of the expires header</span></div><div><span style="color: rgb(51, 51, 51);">   is a valid unsigned integer.</span></div><div><span style="color: rgb(51, 51, 51);"> * proxy require - (512) - checks if all items of the proxy require</span></div><div><span style="color: rgb(51, 51, 51);">   header are present in the list of the extensions from the module</span></div><div><span style="color: rgb(51, 51, 51);">   parameter proxy_require.</span></div><div><span style="color: rgb(51, 51, 51);"> * parse uri's - (1024) - checks if the specified URIs are present and</span></div><div><span style="color: rgb(51, 51, 51);">   parseable by the Kamailio parsers</span></div><div><span style="color: rgb(51, 51, 51);"> * digest credentials (2048) - Check all instances of digest</span></div><div><span style="color: rgb(51, 51, 51);">   credentials in a message. The test checks whether there are all</span></div><div><span style="color: rgb(51, 51, 51);">   required digest parameters and that they have meaningful values.</span></div><div><br/></div><div><br/></div><div>3.2. uri_checks (integer)</div><div>   This parameter determines which URIs are going to be checked if the</div><div>   'parse uri' will be executed.</div><div><br/></div><div>   Default value is 7. This resolves to the following list of parsed URIs:</div><div>   Request URI (1), From URI (2) and To URI (4).</div><div><br/></div><div>   Example 1.2. Set uri_checks parameter</div><div>...</div><div>modparam(&quot;sanity&quot;, &quot;uri_checks&quot;, 3)</div><div>...</div><div><br/></div></div><div><br/></div><div>11.伪变量</div><div>$si  - Source IP address (reference to IP source address of the message)</div><div>$sp - Source port (reference to the source port of the message)</div><div><br/></div><div><br/></div><div><a href="https://www.kamailio.org/wiki/cookbooks/4.4.x/pseudovariables">https://www.kamailio.org/wiki/cookbooks/4.4.x/pseudovariables</a></div><div><a href="https://www.kamailio.org/wiki/alphaindexes/4.4.x/modfunctions">https://www.kamailio.org/wiki/alphaindexes/4.4.x/modfunctions</a></div><div><br/></div><div><br/></div></span>
</div></body></html> 