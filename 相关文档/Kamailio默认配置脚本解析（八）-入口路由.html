<html>
<head>
  <title>Kamailio默认配置脚本解析（八）-入口路由</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="818"/>
<h1>Kamailio默认配置脚本解析（八）-入口路由</h1>

<div>
<span><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>01 request_route {</div><div>02    route(REQINIT); </div><div>03    route(NATDETECT);</div><div>04    if(is_method(&quot;CANCEL&quot;)) {</div><div>05        if(t_check_trans()) {</div><div>06            route(RELAY);</div><div>07        }</div><div>08        exit;</div><div>09    }</div><div>10    route(WITHINDLG);</div><div>11    ### only initial request (no tag in &quot;To:&quot; header)</div><div>12    if(t_precheck_trans()) { //处理重发的消息</div><div>13        t_check_trans();</div><div>14        exit;</div><div>15    }</div><div>16    t_check_trans();</div><div>17    route(AUTH);</div><div>18    remove_hf(&quot;Route&quot;);</div><div>19    if(is_method(&quot;INVITE|SUBSCRIBE&quot;)) {</div><div>20        record_route();</div><div>21    }</div><div>22    if(is_method(&quot;INVITE&quot;)) {</div><div>23        setflag(FLT_ACC);</div><div>24    }</div><div>25    route(SIPOUT);</div><div>26    ### request for my local domains</div><div>27    route(PRESENCE);</div><div>28    route(REGISTRAR);</div><div>29    if($rU==$null) {</div><div>30        sl_send_reply(&quot;484&quot;,&quot;Address Incomplete&quot;);</div><div>31        exit;</div><div>32    }</div><div>33    route(PSTN);</div><div>34    route(LOCATION);</div><div>}</div></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div>02.详见：<a href="Kamailio默认配置脚本解析（一）-SIP请求信令的初始化检查.html">evernote:///view/449888/s8/dc23c3e8-7232-425e-a189-837797e3174f/dc23c3e8-7232-425e-a189-837797e3174f/</a></div><div><br/></div><div>03.详见：<a href="Kamailio默认配置脚本解析（二）-NAT检测路由.html">evernote:///view/449888/s8/c96eba33-dcbb-4b0c-b574-6adb61f6db33/c96eba33-dcbb-4b0c-b574-6adb61f6db33/</a></div><div><br/></div><div>05.t_check_trans函数由模块tm.so提供，该函数的功能是：</div><div>快速检查消息是否属于某个transaction，或者与某个transaction有关。对于不同的消息，它的处理不太相同：</div><ul><li>对于SIP请求的回复信令，如果该信令属于某个存在的transaction，则该函数返回true；否则，返回false</li><li>对于CANCEL请求，如果该请求与之前的INVITE请求由关联，则返回true；否则，返回 false。这种情况下，它的功能与函数t_lookup_cancel函数一样</li><li>对于ACK信令，如果这个ACK信令是针对某个“negative replies”或者是针对某个“local transactions”的确认，并且这个ACK是属于某个transaction，那么该函数会终止整个脚本；否则返回false。</li><li>对于“end-to-end”的ACK信令（针对INVITE事务的2XX回复的ACK信令，就是“end-to-end”的ACK信令），如果这个INVITE还处于活跃状态，那么该函数返回true；否则，返回false.</li></ul><div>以下内容摘自README.tm：</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>* For a SIP Reply it returns true if the reply belongs to an existing</div><div>  transaction and false otherwise.</div><div>* For a CANCEL it behaves exactly as t_lookup_cancel(): returns true</div><div>  if a corresponding INVITE transaction exists for the CANCEL and</div><div>  false otherwise.</div><div>* For ACKs to negative replies or for ACKs to local transactions it</div><div>  will terminate the script if the ACK belongs to a transaction (it</div><div>  would make very little sense to process an ACK to a negative reply</div><div>  for an existing transaction in some other way then to simply pass</div><div>  it to tm) or return false if not.</div><div>* For end-to-end ACKs (ACKs to 2xx responses for forwarded INVITE</div><div>  transactions) it will return true if the corresponding INVITE</div><div>  transaction is found and still active and false if not.</div></div><div><br/></div><div>06.详见：<a href="Kamailio默认配置脚本解析（三）- 转发路由.html">evernote:///view/449888/s8/d36af3e6-840c-409a-865f-c30848da35cf/d36af3e6-840c-409a-865f-c30848da35cf/</a></div><div><br/></div><div>10.详见：<a href="Kamailio默认配置脚本解析（四）-处理SIP dialogs请求的路由.html">evernote:///view/449888/s8/6cb9a456-36f0-4763-a079-e42cf9b222b1/6cb9a456-36f0-4763-a079-e42cf9b222b1/</a></div><div><br/></div><div>12.t_precheck_trans函数由模块tmx.so（tm.so模块的扩展）提供，该函数的功能是：</div><div>检查当前正在处理的消息是否已被其他进程处理。该函数对于重发消息的处理非常有用。通常的用法是：</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>...</div><div># 处理重发</div><div>if(t_precheck_trans()) {</div><div>    t_check_trans();</div><div>    exit;</div><div>}</div><div>t_check_trans();</div><div>...</div></div><div>需要注意的是，ACK信令和CANCEL信令该函数并不做检查，永远返回false。</div><div><br/></div><div>17.详见：<a href="Kamailio默认配置脚本解析（五）-认证路由.html">evernote:///view/449888/s8/c1178c32-acb2-46cf-98f1-74fd263f5a5a/c1178c32-acb2-46cf-98f1-74fd263f5a5a/</a></div><div><br/></div><div>18.remove_hf函数由模块textops.so提供，该函数的功能是：</div><div>移除信令中的头，头的名称由参数指定，参数不区分大小写。</div><div><br/></div><div>20.record_route函数由模块rr.so提供，该函数的功能是：</div><div>添加一个新的Record-Route:到消息中。新增的Record-Route:会被添加到其他Record-Route的最前端。</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>Record-Route:头和Route:应该是同一个概念？？？</div></div><div>该函数还可以带一个字符串参数，参数必须以“;name=value”的形式提供。如果传递了参数，该参数值会添加到Record-Route的后面。参数中可以包含伪变量。</div><div><br/></div><div>25.详见：<a href="Kamailio默认配置脚本解析（六）-SIP请求往外分发路由.html">evernote:///view/449888/s8/ee7a1c92-3bbd-4fcf-a587-1d9e710ad24d/ee7a1c92-3bbd-4fcf-a587-1d9e710ad24d/</a></div><div><br/></div><div>28.详见：<a href="Kamailio默认配置脚本解析（七）-注册路由.html">evernote:///view/449888/s8/e2c28e26-0194-4c30-9ce5-0728004c366b/e2c28e26-0194-4c30-9ce5-0728004c366b/</a></div><div><br/></div><div><br/></div></span>
</div></body></html> 